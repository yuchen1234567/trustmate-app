<%- include('partials/navbar') %>

<div class="cart-page">
    <div class="page-header">
        <div class="page-header-content">
            <h1 class="page-title">
                <span class="page-icon">üõí</span>
                Your Shopping Cart
            </h1>
            <p class="page-subtitle">Review your items before checkout</p>
        </div>
    </div>
    
    <% if (typeof successMessage !== 'undefined' && successMessage) { %>
        <div class="success-message"><%= successMessage %></div>
    <% } %>
    
    <% if (typeof error !== 'undefined' && error) { %>
        <div class="error-message"><%= error %></div>
    <% } %>
    
    <% if (cartItems.length === 0) { %>
        <div class="empty-state">
            <div class="empty-icon">üõí</div>
            <h3>Your Cart is Empty</h3>
            <p>Start shopping and add items to your cart!</p>
            <a href="/services" class="btn-primary">Browse Services</a>
        </div>
    <% } else { %>
        <div class="cart-container">
            <div class="cart-items-section">
                <div class="section-header-small">
                    <h2>Cart Items (<%= cartItems.length %>)</h2>
                </div>
                
                <div class="cart-items-list">
                    <% cartItems.forEach((item, index) => { 
                        const unitPrice = typeof item.price === 'number' ? item.price : parseFloat(item.price || 0);
                    %>
                        <div class="cart-item-card" data-item-index="<%= index %>" data-unit-price="<%= unitPrice %>">
                            <div class="item-main-info">
                                <div class="item-icon">üéØ</div>
                                <div class="item-details">
                                    <h3 class="item-title"><%= item.title %></h3>
                                    <p class="item-seller">
                                        <span class="seller-icon">üè™</span>
                                        <%= item.business_name %>
                                    </p>
                                </div>
                            </div>
                            
                            <div class="item-pricing">
                                <div class="price-info">
                                    <span class="price-label">Unit Price</span>
                                    <span class="price-value">$<%= unitPrice.toFixed(2) %></span>
                                </div>
                                
                                <div class="quantity-control">
                                    <form action="/cart/update" method="POST" class="quantity-form-inline">
                                        <input type="hidden" name="cart_id" value="<%= item.cart_id %>">
                                        <label class="quantity-label">Quantity</label>
                                        <div class="quantity-input-group">
                                            <input type="number" name="quantity" value="<%= item.quantity %>" min="1" max="10" class="quantity-input" data-item-index="<%= index %>" onchange="updateOrderSummary()">
                                            <button type="submit" class="btn-update">
                                                <span>‚úì</span>
                                            </button>
                                        </div>
                                    </form>
                                </div>
                                
                                <div class="subtotal-info">
                                    <span class="subtotal-label">Subtotal</span>
                                    <span class="subtotal-value" id="subtotal-<%= index %>">$<%= (unitPrice * item.quantity).toFixed(2) %></span>
                                </div>
                            </div>
                            
                            <div class="item-actions">
                                <a href="/cart/remove/<%= item.cart_id %>" class="btn-remove" onclick="return confirm('Remove this item from cart?')">
                                    <span>üóëÔ∏è</span>
                                    Remove
                                </a>
                            </div>
                        </div>
                    <% }); %>
                </div>
            </div>
            
            <div class="cart-summary-section">
                <div class="summary-card">
                    <h2 class="summary-title">
                        <span class="summary-icon">üí∞</span>
                        Order Summary
                    </h2>
                    
                    <div class="summary-details">
                        <div class="summary-row">
                            <span class="summary-label">Items (<span id="item-count"><%= cartItems.length %></span>)</span>
                            <span class="summary-value" id="items-total">$<%= typeof total === 'number' ? total.toFixed(2) : '0.00' %></span>
                        </div>
                        
                        <div class="summary-row">
                            <span class="summary-label">Service Fee</span>
                            <span class="summary-value">$0.00</span>
                        </div>
                        
                        <div class="summary-divider"></div>
                        
                        <div class="summary-row summary-total">
                            <span class="summary-label">Total</span>
                            <span class="summary-value" id="order-total">$<%= typeof total === 'number' ? total.toFixed(2) : '0.00' %></span>
                        </div>
                    </div>
                    
                    <div class="summary-actions">
                        <a href="/checkout" class="btn-checkout">
                            <span>üîí</span>
                            Proceed to Checkout
                        </a>
                        <a href="/services" class="btn-continue-shopping">
                            <span>‚Üê</span>
                            Continue Shopping
                        </a>
                        <a href="/cart/clear" class="btn-clear-cart" onclick="return confirm('Clear all items from cart?')">
                            <span>üóëÔ∏è</span>
                            Clear Cart
                        </a>
                    </div>
                </div>
                
                <div class="trust-badges">
                    <div class="trust-badge-item">
                        <span class="badge-icon">üîí</span>
                        <span class="badge-text">Secure Payment</span>
                    </div>
                    <div class="trust-badge-item">
                        <span class="badge-icon">‚úÖ</span>
                        <span class="badge-text">Verified Sellers</span>
                    </div>
                    <div class="trust-badge-item">
                        <span class="badge-icon">üí¨</span>
                        <span class="badge-text">24/7 Support</span>
                    </div>
                </div>
            </div>
        </div>
    <% } %>
</div>

<script>
function updateOrderSummary() {
    const cartItems = document.querySelectorAll('.cart-item-card');
    let total = 0;
    
    cartItems.forEach((item) => {
        const index = item.dataset.itemIndex;
        const unitPrice = parseFloat(item.dataset.unitPrice) || 0;
        const quantityInput = item.querySelector('.quantity-input');
        const quantity = parseInt(quantityInput.value) || 1;
        
        // Calculate subtotal for this item
        const subtotal = unitPrice * quantity;
        total += subtotal;
        
        // Update item subtotal display
        const subtotalEl = document.getElementById('subtotal-' + index);
        if (subtotalEl) {
            subtotalEl.textContent = '$' + subtotal.toFixed(2);
        }
    });
    
    // Update order summary totals
    const itemsTotalEl = document.getElementById('items-total');
    const orderTotalEl = document.getElementById('order-total');
    
    if (itemsTotalEl) {
        itemsTotalEl.textContent = '$' + total.toFixed(2);
    }
    if (orderTotalEl) {
        orderTotalEl.textContent = '$' + total.toFixed(2);
    }
}

// Also update on input (not just change) for immediate feedback
document.querySelectorAll('.quantity-input').forEach(input => {
    input.addEventListener('input', updateOrderSummary);
});

// Run on page load to calculate initial totals
updateOrderSummary();
</script>

<%- include('partials/footer') %>
