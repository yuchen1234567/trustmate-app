<%- include('partials/navbar') %>

<div class="order-detail-page">
    <div class="page-header">
        <div class="page-header-content">
            <div class="page-breadcrumb">
                <a href="/orders">üì¶ My Orders</a>
                <span class="breadcrumb-separator">‚Ä∫</span>
                <span class="breadcrumb-current">Order #<%= order.order_id %></span>
            </div>
            <h1 class="page-title">
                <span class="page-icon">üìã</span>
                Order #<%= order.order_id %>
            </h1>
        </div>
    </div>

    <% if (errorMessage) { %>
        <div class="error-message"><%= errorMessage %></div>
    <% } %>
    <% if (successMessage) { %>
        <div class="success-message"><%= successMessage %></div>
    <% } %>
    
    <div class="order-detail-container">
        <div class="order-main-content">
            <div class="order-info-card">
                <h2 class="card-title">
                    <span class="title-icon">‚ÑπÔ∏è</span>
                    Order Information
                </h2>
                
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-icon">üìÖ</span>
                        <div class="info-content">
                            <span class="info-label">Order Date</span>
                            <span class="info-value"><%= new Date(order.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %></span>
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <span class="info-icon">üìä</span>
                        <div class="info-content">
                            <span class="info-label">Order Status</span>
                            <span class="info-value">
                                <span class="status-badge status-<%= order.status %>">
                                    <% if (order.status === 'completed') { %>üéâ<% } else if (order.status === 'accepted') { %>‚úÖ<% } else if (order.status === 'cancelled') { %>‚ùå<% } else { %>‚è≥<% } %>
                                    <%= order.status %>
                                </span>
                            </span>
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <span class="info-icon">üí≥</span>
                        <div class="info-content">
                            <span class="info-label">Payment Status</span>
                            <span class="info-value">
                                <span class="status-badge status-<%= order.payment_status || 'pending' %>">
                                    <% if ((order.payment_status || 'pending') === 'paid') { %>üí∞<% } else { %>‚è≥<% } %>
                                    <%= order.payment_status || 'pending' %>
                                </span>
                            </span>
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <span class="info-icon">üíµ</span>
                        <div class="info-content">
                            <span class="info-label">Total Amount</span>
                            <span class="info-value total-amount">$<%= typeof order.total_amount === 'number' ? order.total_amount.toFixed(2) : parseFloat(order.total_amount || 0).toFixed(2) %></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="order-items-card">
                <h2 class="card-title">
                    <span class="title-icon">üì¶</span>
                    Order Items
                </h2>
                
                <div class="items-list">
                    <% orderItems.forEach(item => { %>
                        <div class="order-item-row">
                            <div class="item-main">
                                <div class="item-icon-box">üéØ</div>
                                <div class="item-details">
                                    <h4 class="item-title"><%= item.title %></h4>
                                    <p class="item-seller">
                                        <span class="seller-icon">üè™</span>
                                        <%= item.business_name %>
                                    </p>
                                </div>
                            </div>
                            <div class="item-pricing">
                                <div class="pricing-detail">
                                    <span class="pricing-label">Unit Price</span>
                                    <span class="pricing-value">$<%= typeof item.price === 'number' ? item.price.toFixed(2) : parseFloat(item.price || 0).toFixed(2) %></span>
                                </div>
                                <div class="pricing-detail">
                                    <span class="pricing-label">Quantity</span>
                                    <span class="pricing-value">√ó<%= item.quantity %></span>
                                </div>
                                <div class="pricing-detail subtotal">
                                    <span class="pricing-label">Subtotal</span>
                                    <span class="pricing-value">$<%= typeof item.price === 'number' ? (item.price * item.quantity).toFixed(2) : (parseFloat(item.price || 0) * item.quantity).toFixed(2) %></span>
                                </div>
                            </div>
                        </div>
                    <% }); %>
                </div>
            </div>
        </div>
        
        <div class="order-sidebar">
            <div class="actions-card">
                <h3 class="actions-title">
                    <span class="title-icon">‚ö°</span>
                    Quick Actions
                </h3>
                
                <div class="actions-list">
                    <% if (user && user.role === 'buyer' && order.payment_status !== 'paid' && order.status !== 'cancelled') { %>
                        <form action="/payments/nets/retry/<%= order.order_id %>" method="POST">
                            <button type="submit" class="action-btn action-pay">
                                <span class="btn-icon">üí≥</span>
                                <span class="btn-text">Pay with NETS QR</span>
                            </button>
                        </form>
                    <% } %>
                    
                    <% if (order.status === 'pending' || order.status === 'accepted') { %>
                        <% if (order.payment_status === 'paid') { %>
                            <form action="/orders/<%= order.order_id %>/status" method="POST">
                                <input type="hidden" name="status" value="completed">
                                <button type="submit" class="action-btn action-complete">
                                    <span class="btn-icon">‚úÖ</span>
                                    <span class="btn-text">Mark as Completed</span>
                                </button>
                            </form>
                        <% } %>

                        <form action="/orders/<%= order.order_id %>/cancel" method="POST">
                            <button type="submit" class="action-btn action-cancel" onclick="return confirm('Are you sure you want to cancel this order?')">
                                <span class="btn-icon">‚ùå</span>
                                <span class="btn-text">Cancel Order</span>
                            </button>
                        </form>
                    <% } %>
                    
                    <% if (order.status === 'completed') { %>
                        <% if (review) { %>
                            <a href="/reviews/edit/<%= review.review_id %>" class="action-btn action-review">
                                <span class="btn-icon">‚úèÔ∏è</span>
                                <span class="btn-text">Edit Review</span>
                            </a>
                        <% } else { %>
                            <a href="/reviews/create/<%= order.order_id %>" class="action-btn action-review">
                                <span class="btn-icon">‚≠ê</span>
                                <span class="btn-text">Leave a Review</span>
                            </a>
                        <% } %>
                    <% } %>
                    
                    <a href="/chat/<%= order.order_id %>" class="action-btn action-chat">
                        <span class="btn-icon">üí¨</span>
                        <span class="btn-text">Chat with Seller</span>
                    </a>
                </div>
            </div>
            
            <% if (review) { %>
                <div class="review-preview-card">
                    <h3 class="review-preview-title">
                        <span class="title-icon">‚≠ê</span>
                        Your Review
                    </h3>
                    
                    <div class="review-preview-content">
                        <div class="review-stars-display">
                            <% for (let i = 1; i <= 5; i++) { %>
                                <span class="star <%= i <= review.rating ? 'filled' : '' %>">‚òÖ</span>
                            <% } %>
                            <span class="rating-number"><%= review.rating %>/5</span>
                        </div>
                        
                        <p class="review-comment">"<%= review.comment || 'No written comment yet.' %>"</p>
                        
                        <% if (review.tags) { %>
                            <div class="review-tags-display">
                                <% review.tags.split(',').forEach(tag => { %>
                                    <span class="tag-item"><%= tag.trim() %></span>
                                <% }); %>
                            </div>
                        <% } %>
                        
                        <p class="review-date">
                            <span class="date-icon">üìÖ</span>
                            <%= new Date(review.created_at).toLocaleDateString() %>
                        </p>
                    </div>
                </div>
            <% } %>
        </div>
    </div>
</div>

<%- include('partials/footer') %>
