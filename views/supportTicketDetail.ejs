<% if (user.role === 'customer_service') { %>
    <%- include('partials/csNavbar') %>
<% } else { %>
    <%- include('partials/navbar') %>
<% } %>

<div class="container">
    <div class="ticket-detail-page">
        <div class="ticket-header-section">
            <div class="ticket-title">
                <h1>#<%= ticket.ticket_id %> - <%= ticket.subject %></h1>
                <span class="status-badge status-<%= ticket.status %>">
                    <%= ticket.status === 'pending' ? 'Pending' : 
                        ticket.status === 'in_progress' ? 'In Progress' : 
                        ticket.status === 'resolved' ? 'Resolved' : 'Closed' %>
                </span>
            </div>
            
            <div class="ticket-metadata">
                <div class="meta-item">
                    <strong>Category:</strong>
                    <span class="category-badge">
                        <%= ticket.category === 'order_issue' ? 'Order Issue' :
                            ticket.category === 'payment_issue' ? 'Payment Issue' :
                            ticket.category === 'service_inquiry' ? 'Service Inquiry' :
                            ticket.category === 'technical_support' ? 'Technical Support' :
                            ticket.category === 'complaint' ? 'Complaint' : 'Other' %>
                    </span>
                </div>
                <div class="meta-item">
                    <strong>Priority:</strong>
                    <span class="priority-badge priority-<%= ticket.priority %>">
                        <%= ticket.priority === 'urgent' ? 'ðŸ”´ Urgent' :
                            ticket.priority === 'high' ? 'ðŸŸ  High' :
                            ticket.priority === 'medium' ? 'ðŸŸ¡ Medium' : 'ðŸŸ¢ Low' %>
                    </span>
                </div>
                <div class="meta-item">
                    <strong>Created:</strong> <%= new Date(ticket.created_at).toLocaleString('en-US') %>
                </div>
                <div class="meta-item">
                    <strong>Submitted by:</strong> <%= ticket.user_name %> (<%= ticket.user_email %>)
                </div>
                <% if (ticket.assigned_name) { %>
                    <div class="meta-item">
                        <strong>Assigned Agent:</strong> <%= ticket.assigned_name %>
                    </div>
                <% } %>
                <% if (ticket.order_id) { %>
                    <div class="meta-item">
                        <strong>Related Order:</strong>
                        <a href="/orders/<%= ticket.order_id %>">#<%= ticket.order_id %></a>
                    </div>
                <% } %>
            </div>

            <!-- CS Actions -->
            <% if (user.role === 'customer_service' || user.role === 'admin') { %>
                <div class="cs-actions">
                    <% if (!ticket.assigned_to) { %>
                        <form action="/cs/tickets/<%= ticket.ticket_id %>/assign" method="POST" style="display: inline;">
                            <button type="submit" class="btn btn-primary">Assign to Me</button>
                        </form>
                    <% } %>
                    
                    <form action="/cs/tickets/<%= ticket.ticket_id %>/status" method="POST" style="display: inline;">
                        <select name="status" onchange="this.form.submit()" class="status-select">
                            <option value="">Change Status...</option>
                            <option value="pending" <%= ticket.status === 'pending' ? 'selected' : '' %>>Pending</option>
                            <option value="in_progress" <%= ticket.status === 'in_progress' ? 'selected' : '' %>>In Progress</option>
                            <option value="resolved" <%= ticket.status === 'resolved' ? 'selected' : '' %>>Resolved</option>
                            <option value="closed" <%= ticket.status === 'closed' ? 'selected' : '' %>>Closed</option>
                        </select>
                    </form>
                    
                    <form action="/cs/tickets/<%= ticket.ticket_id %>/priority" method="POST" style="display: inline;">
                        <select name="priority" onchange="this.form.submit()" class="priority-select">
                            <option value="">Change Priority...</option>
                            <option value="low" <%= ticket.priority === 'low' ? 'selected' : '' %>>Low</option>
                            <option value="medium" <%= ticket.priority === 'medium' ? 'selected' : '' %>>Medium</option>
                            <option value="high" <%= ticket.priority === 'high' ? 'selected' : '' %>>High</option>
                            <option value="urgent" <%= ticket.priority === 'urgent' ? 'selected' : '' %>>Urgent</option>
                        </select>
                    </form>
                </div>
            <% } %>
        </div>

        <!-- Messages Section -->
        <div class="messages-section">
            <h2>Conversation</h2>
            <div class="messages-container">
                <% messages.forEach(message => { %>
                    <div class="message <%= message.sender_id === user.user_id ? 'message-own' : 'message-other' %> <%= message.is_internal ? 'message-internal' : '' %>">
                        <div class="message-header">
                            <strong><%= message.username %></strong>
                            <% if (message.role === 'customer_service') { %>
                                <span class="role-badge cs-badge">Agent</span>
                            <% } else if (message.role === 'admin') { %>
                                <span class="role-badge admin-badge">Admin</span>
                            <% } %>
                            <% if (message.is_internal) { %>
                                <span class="internal-badge">ðŸ”’ Internal Note</span>
                            <% } %>
                            <span class="message-time"><%= new Date(message.created_at).toLocaleString('en-US') %></span>
                        </div>
                        <div class="message-content">
                            <%= message.message %>
                        </div>
                    </div>
                <% }); %>
            </div>
        </div>

        <!-- Reply Section -->
        <% if (ticket.status !== 'closed') { %>
            <div class="reply-section">
                <h3>Reply</h3>
                <form action="/support/tickets/send" method="POST">
                    <input type="hidden" name="ticket_id" value="<%= ticket.ticket_id %>">
                    
                    <textarea name="message" rows="4" placeholder="Type your reply..." required></textarea>
                    
                    <div class="reply-actions">
                        <% if (user.role === 'customer_service' || user.role === 'admin') { %>
                            <label class="checkbox-label">
                                <input type="checkbox" name="is_internal" value="true">
                                Internal Note (CS only)
                            </label>
                        <% } %>
                        <button type="submit" class="btn btn-primary">Send</button>
                    </div>
                </form>
            </div>
        <% } else { %>
            <div class="alert alert-info">This ticket is closed and cannot receive new replies</div>
        <% } %>
    </div>
</div>

<style>
.ticket-detail-page {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
}

.ticket-header-section {
    background: white;
    padding: 25px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.ticket-title {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.ticket-title h1 {
    margin: 0;
    font-size: 24px;
}

.ticket-metadata {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    margin: 20px 0;
}

.meta-item {
    font-size: 14px;
}

.cs-actions {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #eee;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.status-select, .priority-select {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.messages-section {
    background: white;
    padding: 25px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.messages-container {
    max-height: 600px;
    overflow-y: auto;
    padding: 15px 0;
}

.message {
    margin-bottom: 20px;
    padding: 15px;
    border-radius: 8px;
    background: #f5f5f5;
}

.message-own {
    background: #e3f2fd;
    margin-left: 50px;
}

.message-other {
    background: #f5f5f5;
    margin-right: 50px;
}

.message-internal {
    background: #fff3e0;
    border: 2px solid #ff9800;
}

.message-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
    font-size: 14px;
}

.message-time {
    color: #666;
    font-size: 12px;
    margin-left: auto;
}

.role-badge {
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 11px;
    font-weight: 500;
}

.cs-badge {
    background: #4caf50;
    color: white;
}

.admin-badge {
    background: #f44336;
    color: white;
}

.internal-badge {
    background: #ff9800;
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 11px;
}

.message-content {
    white-space: pre-wrap;
    word-wrap: break-word;
}

.reply-section {
    background: white;
    padding: 25px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.reply-section textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-family: inherit;
    font-size: 14px;
    resize: vertical;
}

.reply-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 15px;
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
}
</style>

<%- include('partials/footer') %>
