<%- include('partials/navbar') %>

<div style="max-width: 920px; margin: 40px auto; padding: 0 16px;">
  <div style="background:#fff; border-radius:16px; padding:24px; border:1px solid rgba(0,0,0,0.08); box-shadow:0 10px 24px rgba(0,0,0,0.08);">
    <h1 style="margin:0 0 10px; font-size:24px;">Scan to Pay (NETS QR)</h1>
    <p style="margin:0 0 16px; color:#666; font-size:14px;">
      Order #<%= orderId %> - Total $<%= total %>
    </p>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:24px; align-items:center;">
      <div style="text-align:center;">
        <img src="<%= qrCodeUrl %>" alt="NETS QR Code" style="max-width: 260px; width:100%; border-radius:12px; border:1px solid #eee; background:#fafafa; padding:12px;">
        <div id="nets-status" style="margin-top:14px; font-weight:600; color:#2b6cb0;">
          Awaiting payment confirmation...
        </div>
        <div id="nets-timer" style="margin-top:6px; color:#777; font-size:13px;">
          Time remaining: 5:00
        </div>
      </div>

      <div>
        <div style="background:#f7f7f7; border:1px solid #eee; padding:16px; border-radius:12px;">
          <ol style="margin:0; padding-left:18px; color:#444; line-height:1.6;">
            <li>Open your NETS or banking app.</li>
            <li>Scan the QR code to confirm payment.</li>
            <li>Keep this page open while confirmation is processed.</li>
          </ol>
        </div>

        <div style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap;">
          <a href="/orders/<%= orderId %>" class="btn-secondary" style="margin-left:0;">Back to Order</a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  (() => {
    const statusEl = document.getElementById('nets-status');
    const timerEl = document.getElementById('nets-timer');
    const successUrl = '/payments/nets/success?orderId=<%= orderId %>';
    const failUrl = '/payments/nets/fail?orderId=<%= orderId %>';
    const statusUrl = '/payments/nets/status/<%= txnRetrievalRef %>';

    const eventSource = new EventSource(statusUrl);

    eventSource.onmessage = (event) => {
      const data = JSON.parse(event.data || '{}');
      if (data.message) {
        statusEl.textContent = data.message;
      }
      if (data.success) {
        eventSource.close();
        window.location.href = successUrl;
      }
      if (data.fail) {
        eventSource.close();
        window.location.href = failUrl;
      }
    };

    eventSource.onerror = () => {
      statusEl.textContent = 'Connection lost. Attempting to reconnect...';
    };

    let remainingTime = 300;
    const timerInterval = setInterval(() => {
      const minutes = Math.floor(remainingTime / 60);
      const seconds = String(remainingTime % 60).padStart(2, '0');
      timerEl.textContent = `Time remaining: ${minutes}:${seconds}`;
      remainingTime -= 1;

      if (remainingTime < 0) {
        clearInterval(timerInterval);
        eventSource.close();
        window.location.href = failUrl;
      }
    }, 1000);
  })();
</script>

<%- include('partials/footer') %>
