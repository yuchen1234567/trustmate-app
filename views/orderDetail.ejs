<%- include('partials/navbar') %>

<div class="order-detail-page">
    <h1>Order #<%= order.order_id %></h1>

    <% if (errorMessage) { %>
        <div class="error-message" style="margin: 16px 0;"><%= errorMessage %></div>
    <% } %>
    <% if (successMessage) { %>
        <div class="success-message" style="margin: 16px 0;"><%= successMessage %></div>
    <% } %>
    
    <div class="order-info">
        <p><strong>Date:</strong> <%= new Date(order.created_at).toLocaleDateString() %></p>
        <p><strong>Status:</strong> <span class="status-badge status-<%= order.status %>"><%= order.status %></span></p>
        <p><strong>Payment:</strong> <span class="status-badge status-<%= order.payment_status || 'pending' %>"><%= order.payment_status || 'pending' %></span></p>
        <p><strong>Total:</strong> $<%= typeof order.total_amount === 'number' ? order.total_amount.toFixed(2) : parseFloat(order.total_amount || 0).toFixed(2) %></p>
    </div>
    
    <h2>Order Items</h2>
    <table class="order-items-table">
        <thead>
            <tr>
                <th>Service</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Subtotal</th>
            </tr>
        </thead>
        <tbody>
            <% orderItems.forEach(item => { %>
                <tr>
                    <td>
                        <div class="item-info">
                            <div>
                                <h4><%= item.title %></h4>
                                <p><%= item.business_name %></p>
                            </div>
                        </div>
                    </td>
                    <td>$<%= typeof item.price === 'number' ? item.price.toFixed(2) : parseFloat(item.price || 0).toFixed(2) %></td>
                    <td><%= item.quantity %></td>
                    <td>$<%= typeof item.price === 'number' ? (item.price * item.quantity).toFixed(2) : (parseFloat(item.price || 0) * item.quantity).toFixed(2) %></td>
                </tr>
            <% }); %>
        </tbody>
    </table>
    
    <div class="order-actions">
        <% if (user && user.role === 'buyer' && order.payment_status !== 'paid' && order.status !== 'cancelled') { %>
            <form action="/payments/nets/retry/<%= order.order_id %>" method="POST" style="display: inline;">
                <button type="submit" class="btn-primary">Pay with NETS QR</button>
            </form>
        <% } %>
        <% if (order.status === 'pending' || order.status === 'accepted') { %>
            <% if (order.payment_status === 'paid') { %>
                <form action="/orders/<%= order.order_id %>/status" method="POST" style="display: inline;">
                    <input type="hidden" name="status" value="completed">
                    <button type="submit" class="btn-primary">Mark as Completed</button>
                </form>
            <% } %>

            <form action="/orders/<%= order.order_id %>/cancel" method="POST" style="display: inline;">
                <button type="submit" class="btn-danger">Cancel Order</button>
            </form>
        <% } %>
        
        <% if (order.status === 'completed') { %>
            <% if (review) { %>
                <a href="/reviews/edit/<%= review.review_id %>" class="btn-primary">Edit Review</a>
            <% } else { %>
                <a href="/reviews/create/<%= order.order_id %>" class="btn-primary">Leave a Review</a>
            <% } %>
        <% } %>
        
        <a href="/chat/<%= order.order_id %>" class="btn-secondary">Chat</a>
    </div>

    <% if (review) { %>
        <section class="order-review">
            <div class="review-card">
                <p class="review-card-eyebrow">Your review</p>
                <p class="review-card-quote">"<%= review.comment || 'No written comment yet.' %>"</p>
                <p class="review-card-user"><%= review.username %></p>
                <div class="review-card-stars" aria-label="Rating: <%= review.rating %> out of 5">
                    <% for (let i = 1; i <= 5; i++) { %>
                        <span class="review-card-star <%= i <= review.rating ? 'filled' : '' %>">&#9733;</span>
                    <% } %>
                </div>
                <p class="review-card-meta">Rating: <%= review.rating %>/5 &middot; <%= new Date(review.created_at).toLocaleDateString() %></p>
                <% if (review.tags) { %>
                    <p class="review-card-tags">Tags: <%= review.tags %></p>
                <% } %>
            </div>
        </section>
    <% } %>
</div>

<%- include('partials/footer') %>
