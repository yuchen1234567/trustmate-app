<%- include('partials/navbar') %>

<div style="max-width: 920px; margin: 40px auto; padding: 0 16px;">
  <div style="background:var(--surface); border-radius:16px; padding:24px; border:1px solid var(--border-soft); box-shadow:0 10px 24px rgba(15, 23, 42, 0.08);">
    <h1 style="margin:0 0 10px; font-size:24px;">Scan to Pay (<%= methodLabel %> - Airwallex)</h1>
    <p style="margin:0 0 16px; color:var(--text-muted); font-size:14px;">
      Order #<%= orderId %> - Total <%= currency %> <%= total %>
    </p>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:24px; align-items:center;">
      <div style="text-align:center;">
        <img src="<%= qrCodeUrl %>" alt="<%= methodLabel %> QR Code" style="max-width: 260px; width:100%; border-radius:12px; border:1px solid var(--border-soft); background:var(--surface); padding:12px;">
        <div id="airwallex-status" style="margin-top:14px; font-weight:600; color:var(--accent);">
          Awaiting payment confirmation...
        </div>
        <div id="airwallex-timer" style="margin-top:6px; color:var(--text-muted); font-size:13px;">
          Time remaining: 10:00
        </div>
      </div>

      <div>
        <div style="background:var(--surface-muted); border:1px solid var(--border-soft); padding:16px; border-radius:12px;">
          <ol style="margin:0; padding-left:18px; color:var(--text-muted); line-height:1.6;">
            <li>Open your <%= methodLabel %> app.</li>
            <li>Scan the QR code to confirm payment.</li>
            <li>Keep this page open while confirmation is processed.</li>
          </ol>
        </div>

        <% if (fallbackUrl) { %>
          <div style="margin-top:12px; color:var(--text-muted); font-size:13px;">
            Having trouble scanning? <a href="<%= fallbackUrl %>" target="_blank" rel="noopener noreferrer">Open payment link</a>.
          </div>
        <% } %>

        <div style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap;">
          <a href="/orders/<%= orderId %>" class="btn-secondary" style="margin-left:0;">Back to Order</a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  (() => {
    const statusEl = document.getElementById('airwallex-status');
    const timerEl = document.getElementById('airwallex-timer');
    const intentId = '<%= intentId %>';

    let remainingTime = 600;
    const updateTimer = () => {
      const minutes = Math.floor(remainingTime / 60);
      const seconds = String(remainingTime % 60).padStart(2, '0');
      timerEl.textContent = `Time remaining: ${minutes}:${seconds}`;
    };

    updateTimer();

    const timerInterval = setInterval(() => {
      remainingTime -= 1;
      updateTimer();
      if (remainingTime <= 0) {
        clearInterval(timerInterval);
        clearInterval(pollInterval);
        statusEl.textContent = 'Payment not confirmed in time. You can retry from the order page.';
      }
    }, 1000);

    const pollOnce = async () => {
      try {
        const res = await fetch('/payments/airwallex/finalize', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ intentId })
        });
        const data = await res.json();

        if (data && data.success) {
          clearInterval(timerInterval);
          clearInterval(pollInterval);
          window.location.href = '/orders/' + data.orderId;
          return;
        }

        if (data && data.pending) {
          statusEl.textContent = data.message || `Awaiting payment confirmation (${data.status || 'PENDING'})...`;
          return;
        }

        if (!res.ok) {
          clearInterval(timerInterval);
          clearInterval(pollInterval);
          statusEl.textContent = data && data.error ? data.error : 'Payment not completed. Please try again.';
        }
      } catch (error) {
        statusEl.textContent = 'Unable to check payment status. Retrying...';
      }
    };

    pollOnce();
    const pollInterval = setInterval(pollOnce, 3000);
  })();
</script>

<%- include('partials/footer') %>

